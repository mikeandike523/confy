#!/bin/bash

# file: configure
# A comprehensive installation script for the confy bash and python3-powered cli tool

if [ "$EUID" -ne 0 ]; then
    echo "This script needs to be run as sudo or root."
    exit 1
fi

CONFY_DIR="$(dirname "$(realpath "$BASH_SOURCE[0]")")"

if ! command -v python3 &> /dev/null; then
    echo "Command \"python3\" is not available."
    echo " Please install python3 or check that your terminal and system are configured correctly"
    exit 1
fi

if [ ! -d "$CONFY_DIR/pyenv" ]; then
    echo "Creating Python virtual environment in $CONFY_DIR/pyenv"
    "$CONFY_DIR/__python3" -m venv "$CONFY_DIR/pyenv"
else
    echo "Python virtual environment already exists."
fi
sudo chmod a+x "$CONFY_DIR/confy"
# convenience to run in venv
sudo chmod a+x "$CONFY_DIR/__python3"
# may be helpful to diagnose issues with package installation in venv
sudo chmod a+x "$CONFY_DIR/__pip3"

"$CONFY_DIR/__pip3" install --no-cache --force-reinstall -r "$CONFY_DIR/requirements.txt"

# Check if the symbolic link already exists
if [ -L "/usr/local/bin/confy" ]; then
    # Check if the existing link points to the intended target
    if [ "$(readlink -f "/usr/local/bin/confy")" == "$CONFY_DIR/confy" ]; then
        echo "The symbolic link /usr/local/bin/confy already exists and points to the correct target."
    else
        echo "A symbolic link /usr/local/bin/confy already exists but points to a different target."
        echo "Please manually check and update the link as necessary."
    fi
else
    # If the link does not exist, create it
    sudo ln -s "$CONFY_DIR/confy" "/usr/local/bin/confy"
    echo "Confy has been added to /usr/local/bin"
fi

echo "\"confy\" installation complete."